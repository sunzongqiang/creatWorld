# 消息平台 #
## 业务逻辑 ##
1. 接受请求，校验，生成记录入库。server（core下）
2. 请求记录转为发送记录，server
3. 在调用接口发送短信，linker
4. mannager中处理增删改查
5. static中是静态页面
## 技术栈 ##
- springboot
- springMVC
- springCloud
- rabbitMQ
- redis
>- 但是除了**高性能**之外，Redis 还有一个重要的优点，它的**版本更新速度很快**，并且功能也越来越强大。比如**之前只有 5 种数据类型**，而到**现在已经有 9 种数据类型**。
>- **之前**最常用的功能是把它作为**缓存数据库**，而**现在**你可以使用它来**实现消息队列**了。比如**之前只能单机模式运行，现在已经发展新增了集群模式运行了**；再比如**之前只能单一模式持久化，选择 RDB 或 AOF，现在已经可以混合持久化模式**了。基本实现了鱼和熊掌兼得的境界，特别是集群功能和模块机制的引入，几乎让 Redis 拥有了无限扩展的能力。
>- 大部分人只会用 Redis 的 Key/Value 功能
>>- 我身边有很多朋友和同事，尽管已经有 5、6 年的工作经验了，但对于 Redis 的掌握仍处在最初级的阶段。例如，当存储一个用户信息时，只会把 User 对象先序列化成字符串，把字符串再存储到 Redis 中，然后查询的时候先从字符串中取出，再反序列化出来，其实我们完全可以使用 Hash 类型来存储用户信息，这样我们就省去了序列化和反序列化的麻烦。

>- Redis 还有很多高级功能他们都没有使用到，而这些功能都非常的实用也非常的重要，例如以下这几个：
>>1.主从复制、Redis Sentinel (哨兵) 和 Redis Cluster (集群)；   
>>2.稳定有消息确认 (ACK) 的消息队列 Stream；   
>>3.Redis 实现的延迟队列和定时任务；   
>>4.亿万级数据查询、以及亿万级数据的秒去重；   
>>5.Redis 慢查询与性能优化；   
>>6.Redis 运行原理以及常用数据类型的内部实现。
  
> 掌握以上这些技能点，对你开发稳定并高效的程序有着至关重要的作用，同时也能为你成为架构师打好牢固的基础。   

>- 学习指南   
>>- 基础篇   
> 1.Redis 是如何执行的？   
2.Redis 快速搭建与使用   
3.字符串使用与内部实现原理   
4.字典使用与内部实现原理   
5.列表使用与内部实现原理  
6.集合使用与内部实现原理  
7.有序集合使用与内部实现原理  
8.Redis 持久化——RDB  
9.Redis 持久化——AOF  
10.Redis 持久化——混合持久化  
11.Redis 事务深入解析  
12.Redis 键值过期操作  
13.Redis 过期策略与源码分析  
>>- 进阶篇  
1.Redis 管道技术——Pipeline  
2.查询附近的人——GEO  
3.优秀的基数统计算法——HyperLogLog  
4.游标迭代器(过滤器)——Scan  
5.内存淘汰机制与算法  
6.消息队列——发布订阅模式  
7.消息队列的其他实现方式  
8.消息队列终极解决方案——Stream（上）  
9.消息队列终极解决方案——Stream（下）  
>>- 实战篇  
1.分布式锁详解与代码实战  
2.布隆过滤器安装与使用及原理分析  
3.实现延迟队列的两种方法—完整案例  
4.定时任务案例实战  
5.RediSearch 高性能的全文搜索引擎  
6.Redis 性能测试实战  
7.Redis 慢查询实战  
8.Redis 性能优化实战方案  
9.Redis 主从同步实战  
10.Redis 哨兵模式实战（上）  
11.Redis 哨兵模式实战（下）  
12.Redis 集群模式实战（上）  
13.Redis 集群模式实战（下）  
14.Redis 问题汇总和相关解决方案  
15.技能学习指南  
16.加餐：Redis 的可视化管理工具  
>- 网址  
>> redis.io  
>> redis.cn  
## 数据库表 ##
<table>
<tr><th>表名</th><th>中文说明</th></tr>
<tr><td>MSG_BIZTYPE_CONFIG</td><td>业务类型配置表</td></tr>
<tr><td>MSG_TMPL_CONFIG
</td><td>消息模板配置表
<tr><td>MSG_SEND_TYPE_CONFIG
</td><td>派发方式配置表
<tr><td>MSG_SEND_CONFIG
</td><td>消息派发配置
<tr><td>MSG_SEND_CONFIG_REL
</td><td>消息派发配置方式关联表
<tr><td>MSG_CHANNEL_CONFIG
</td><td>渠道类型表
<tr><td>MSG_CHANNEL_REL CONFIG
</td><td>渠道映射表
<tr><td>MSG_REQUEST
</td><td>消息请求表
<tr><td>MSG_REQUEST_USER
</td><td>请求关联用户表
<tr><td>MSG_SEND_RECORD
</td><td>消息发送记录表
<tr><td>MSG_SEND_RECORD_USER
</td><td>消息发送用户表
<tr><td>APP_USER_MESSAGE
</td><td>用户消息表
<tr><td>XCD_MSG_REQUEST
</td><td>星巢贷消息请求表
<tr><td>MSG_DICT
</td><td>数据字典说明
<tr><td>IMPORT_MSG_REQUEST
</td><td>导入请求表
<tr><td>MSG_FILTER_CONFIG
</td><td>过滤规则配置表
<tr><td>DEVICE_TYPE_CONFIG
</td><td>设备类型信息表
<tr><td>MSG_TYPE_MAPPING
</td><td>消息类型映射表
<tr><td>MSG_LOG
</td><td>短信发送日志记录表
<tr><td>TRANS_MSG_REQUEST
</td><td>外联短信迁移发送请求表
<tr><td>MSG_PRODUCT_CONFIG
</td><td>产品编号表
<tr><td>MSG_CHANNEL
</td><td>渠道号码表
<tr><td>MSG_PRODUCT_TYPE_CONFIG
</td><td>产品类型配置表
<tr><td>MSG_PRODUCT_REL_CONFIG
</td><td>产品编号映射表
<tr><td>MSG_PARAMETER_CONFIG
</td><td>参数配置表
<tr><td>MSG_INTERCEPT_USER
</td><td>拦截用户表
<tr><td>MSG_BLACK_LIST
</td><td>黑名单表
<tr><td>MSG_WHITE_LIST
</td><td>白名单表
<tr><td>MSG_UPSTREAM
</td><td>上行信息表
<tr><td>MSG_FILTER_STRATEGY_REL
</td><td>过虑配置关联表
<tr><td>MSG_FILTER_STRATEGY
</td><td>过滤配置表
<tr><td>MSG_INTERCEPT_REQUEST
</td><td>拦截请求表
<tr><td>MSG_REPORT
</td><td>短信接收状态报告表
<tr><td>MSG_PUSH_REQUEST
</td><td>推送请求表
<tr><td>MSG_PUSH_REQUEST_REL
</td><td>推送请求关联表
<tr><td>MSG_PUSH_REQUEST_CONFIG
</td><td>推送请求配置表
<tr><td>MSG_PUSH_REQUEST_CONFIG_REL
</td><td>推送请求配置关联表
<tr><td>MSG_COOPR_MAPPING
</td><td>合作方编码映射表
<tr><td>MSG_COOPR_CONFIG
</td><td>合作方接口配置表
<tr><td>MSG_COOPR_CONFIG_REL
</td><td>合作方接口配置关联表
<tr><td>BIZ_CODE_CONFIG
</td><td>业务场景配置表
<tr><td>BIZ_CODE_CONFIG_REL
</td><td>业务场景配置关联表
<tr><td>CAPTCHA_APPLY_REQUEST
</td><td>验证码发送请求表
<tr><td>CAPTCHA_RECORD
</td><td>验证码发送记录表
<tr><td>MSG_FILE_REQUEST	
</td><td>请求文件表
<tr><td>MSG_FILE_DETAIL
</td><td>文件明细表
<tr><td>EMAIL_SEND_RECORD
</td><td>邮件发送记录表
<tr><td>BIZ_SEND_SWITCH_LOG
</td><td>业务渠道切换记录
<tr><td>MSG_EMAIL_WHITE_LIST
</td><td>邮件发送白名单
</table>
## 消息平台管理中心 ##
 该系统主要有十个功能模块：  

1.消息平台设置  

>- 业务类型配置  
	- 业务类型配置主要是对业务所需的业务类型进行相应的配置。  
	- 该页面主要包括查询，增加，修改，删除四个按钮。  
- 渠道类型配置
	- 渠道类型配置主要是对业务所需的渠道类型进行相应的配置。  
	- 该页面主要包括查询，增加，修改，删除四个按钮。
- 渠道映射配置  
	- 渠道映射配置主要是对渠道类型配置相关的渠道号映射。  
	- 该页面主要包括查询，增加，修改，删除四个按钮。 
- 消息模板配置
	- 消息模板配置主要配置发送消息所需的模板。
	- 该页面主要包括查询，增加，修改，删除四个按钮。
- 派发方式配置
	- 派发方式配置主要配置发送消息的外部渠道，例如：***信鸽推送，短信推送，队列推送。***
	- 该页面主要包括查询，增加，修改，删除四个按钮。
- 消息派发配置
	- 消息派发配置主要配置消息发送的匹配规则，消息根据消息派发配置匹配相应的派发方式。
	- 该页面主要包括查询，增加，修改，删除四个按钮。每条消息派发配置后带有【消息派发方式】按钮。
- 消息派发配置方式关联
	- 消息派发配置后带有【消息派发方式】按钮，显示该条消息派发配置对应的派发方式及相关信息。
	- 该页面直接在该条消息派发配置下方显示，主要包括增加，修改，删除三个按钮。
	
2.验证码设置  

>- 业务场景配置
	- 业务类型配置主要是对业务所需的业务类型进行相应的配置。
	- 该页面主要包括查询，增加，修改，删除四个按钮。
- 验证码发送记录
	- 验证码发送记录模块负责验证码发送记录的查询功能。
	- 该页面主要包括查询和查看验证码发送用户按钮。 

3.消息请求记录  

>- 消息请求记录
	- 消息请求记录模块负责消息请求记录的查询功能。
	- 该页面主要包括查询和查看消息发送用户按钮。

4.消息发送记录  

>- 消息发送记录
	- 消息发送记录模块负责消息发送记录的查询功能。
	- 该页面主要包括查询和查看消息发送用户按钮。
	
5.用户信息  

>- 用户消息查询
	- 主要负责用户接收消息的查询功能。
	- 该页面主要包括查询按钮。

6.系统管理  
  
>- 字典配置
	- 字典管理主要管理金海尔消费金融消息平台软件用到的数据字典项，系统会默认创建一条字典条目，用户可在这些字典条目的基础上增加、修改、修改子字典项。
	- 该页面中主要包括增加下级字典项、修改、删除三个功能按钮。
- 渠道配置
	- 渠道配置模块主要负责渠道信息的配置和查询。
	- 主要包括渠道的添加和查询功能，
	- 可以根据渠道类型名称，渠道号码进行精确查询。
- 参数配置
	- 参数配置模块主要负责参数信息的配置和查询。
	- 主要包括参数的添加和查询功能，
	- 可以根据参数代码，参数名称进行精确查询。
- 业务渠道切换记录
	- 业务渠道切换记录模块主要负责查询业务渠道切换记录的查询。
	- 主要包括业务渠道切换记录的查询，
	- 可以根据消息派发配置，业务类型，消息派发配置关联id等进行精确查询。

7.手动发送管理  

>- 导入请求
	- 主要功能是将需要手动发送的消息请求通过excel表格导入到系统，进行手动发送。
	- 主要包括查询和导入数据按钮。

8.短信平台发送日志  

>- 短信发送记录查询
	- 短信发送记录模块主要负责短信发送记录的查询。
	- 该页面主要包括发送记录查询和重置按钮。
	- 可根据请求号、系统标识、返回码、请求IP等进行精确查询。
- 短信状态报告查询
	- 短信状态报告查询模块主要负责短信状态报告的查询。
	- 该页面主要包括报告查询和重置查询按钮。
	- 可根据请求号、发送用户、发送渠道、接受状态等进行精确查询。
 


9.发送拦截  

>- 黑名单配置
	- 黑名单配置模块主要功能是进行黑名单的配置和查询，被列入黑名单的用户的请求将被拦截。
	- 主要包括黑名单配置的查询和添加。
	- 可以根据用户ID，手机号，接受终端账号进行精确查询。
- 白名单配置
	- 白名单配置模块主要功能是进行白名单的配置和查询，被列入白名单的用户的请求将不会被拦截并且无视最大发送次数限制。
	- 主要包括白名单配置的查询和添加。
	- 可以根据用户ID，手机号，接受终端账号进行精确查询。
- 邮件域名白名单配置
	- 邮件域名白名单模块主要功能是进行邮件白名单的配置和查询，被列入白名单的用户的请求将不会被拦截并且无视最大发送次数限制。
	- 主要包括邮件域名白名单的查询和添加。
	- 可以根据域名进行精确查询。
- 拦截记录
	- 拦截记录模块主要功能是进行拦截记录的查询。
	- 主要包括拦截记录的查询功能，
	- 可以根据手机号，终端账号，日期等进行精确查询。
- 拦截请求
	- 拦截请求模块主要功能是进行拦截请求的查询。
	- 主要包括拦截请求的查询功能，
	- 可以根据请求号，系统标识，业务类型等进行精确查询。

10.文件请求  

>- 文件请求记录
	- 文件请求记录模块主要功能是进行文件请求记录和文件明细的查询，点击文件明细可查看此文件中的具体信息。
	- 主要包括文件请求记录的查询和查看文件明细。
	- 可根据id，明细文件路径，处理状态等进行精确查询。
- 文件明细记录
	- 文件明细记录模块主要功能是进行文件明细记录的查询。
	- 主要包括文件明细记录的查询。
	- 可根据id，文件请求id，处理状态等进行精确查询。  
## 系统主要流程 ##

1. 通用消息流程  
	- 请求URL：/api/hcmsg/sendMessage  
	- 请求方式：POST  
	- 示例
		- 请求报文：
			<code>
			
				{                                              //参数名称 参数类型 长度 必传 备注
				    "requestNo": "20180309011111",             //请求号	String	32	Y	消息唯一标志
				    "institution": "OUTPLATFORM",              //系统标识	String	32	Y	详见2.系统标识
				    "bizType": "MARKET_ACTIVITY",              //业务类型	String		Y	详见3.业务类型
				    "subBizType":"",                           //细分业务类型	String		N	
				    "bizId": "BizId0001",                      //业务ID	  String  32  Y	  业务流水号
				    "productCode:"",                           //产品编号	String	32	N	产品代码，业务类消息必传
					"channelNo": "",                           //渠道号	String	32	N	渠道代码，业务类消息必传
				    "pushType": "SINGLE_ACCOUNT",              //推送方式	PushTypeEnum Y SINGLE_ACCOUNT：单账户推送MULTI_ACCOUNT：多账户推送ALL：广播推送
				    "pushMsgType":"",                          //推送消息类型	String		N	信鸽推送时设置。1：通知 2：透传消息。iOS平台请填0
					"sendType":"",                             //消息发送方式	SendTypeEnum N	EMAIL：邮件推送；不填：走默认配置发送；
				    "actionType": "",                          //动作类型	int		     N
				    "actionValue": "",                         //动作代码	String	300	 N
				    "bizContent":"{\"A\":\"测试业务数据体\"}",  //业务数据体	String	500	Y	JSON字符串，若不使用传{}
				    "useTmpl":"N",                             //是否使用模板	YesNoEnum	Y	枚举：Y：使用模板  N：不使用模板
				    "msgTitle":"hello",                        //消息标题	String	200	N	是否使用模板为N时，必须设置；消息标题：最大支持255个字，一个字母或者汉字都视为一个字。编码方法：UTF-8
				    "msgContent":"问候20180307000000012",      //消息内容	String	2000	N	是否使用模板为N时，必须设置; 消息内容：最大支持900个字，一个字母或者汉字都视为一个字。编码方法：UTF-8信鸽推送时：消息标题+消息内容+自定义字段不得超过 800 英文字符或 400 非英文字符
				    "custom":"",                               //自定义字段	String	500	N
					"enclosureInfo":"",                                     //附件信息	String	500	N	填写大数据系统对应附件id，多个id之间用英文逗号分隔，中间不得有空格等多余符号
				    "requestTime": "2018-02-07 12:00:00",      //请求时间	String		Y	时间格式：yyyy-MM-dd HH:mm:ss
				    "requestIp": "123.0.0.1",                  //请求IP	String		Y	
				    "userIds": [                               //发送用户列表开始
				         {
				            "userId":"133",                    //接收用户ID	String		N	Crm用户id
				            "mobile":"13361249238",            //手机号码	String		M	短信发送必传
							"email":"",                             //收件箱地址	String		M	邮件发送必填
				            "custNo":"",                       //接收者crmNo	String		N	
				            "custType":null,                   //账户类型	String		N	PERSONAL(个人),MERCHANT(商户),STORE(门店);
				            "custName":"",                     //接收者姓名	String		N	
				            "certNo":"",                       //证件号码	String		N	如若不能提供手机号，则需提供身份证号码
				            "deviceNo":"",                     //终端账户	String		M	APP消息必传
							“custTag”:””                       //用户标签	String		N	用户标签
				        }    
					]
				}
			</code>
		- 返回报文：
			<code>

				{                                             //参数名称 参数类型 空值 备注
				    "head": {
				        "retFlag": "00000",                   //返回码	  String	否	00000：成功
				        "retMsg": "处理成功"                   //返回描述	String	否	
						}
				}
			</code>
		- 请求报文(邮件)：
			<code>
				
				{
				    "requestNo": "20180309011111",
				    "institution": "OUTPLATFORM",
				    "bizType": "MARKET_ACTIVITY",
				    "subBizType":"",
					"bizId": "BizId0001",
					"sendType":"EMAIL",                      //发送方式为：EMAIL
				    "channelNo": "",
				    "pushType": "SINGLE_ACCOUNT",
				    "pushMsgType":"",
				    "actionType": "",
				    "actionValue": "",    
				    "bizContent":"{\"A\":\"测试业务数据体\"}",
				    "useTmpl":"N",
				    "msgTitle":"hello",
					"msgContent":"问候20180307000000012",
					"enclosureInfo":"200198267",             //附件信息
				    "custom":"",
				    "requestTime": "2018-02-07 12:00:00",
				    "requestIp": "123.0.0.1",
				    "userIds": [
				         {
				            "userId":"133",
				            "mobile":"13361249238",
							"email":"xxxxxxx@163.com",      //收件箱地址
				            "custNo":"",
				            "custType":null,
				            "custName":"",
				            "certNo":"",
				            "deviceNo":"",
							“custTag”:””
				        }    
					]
				}
			</code>
		- 返回报文：
			<code>

				{    "head": {
				        "retFlag": "00000",
				        "retMsg": "处理成功"
						}
				}
			</code>
	- 流程概括  
		- 1.**接收消息发送请求报文，对请求参数进行校验，对业务数据体进行json解析。**  
		>根据请求的**业务类型**查询**业务类型配置表**，  
		如果业务类型未配置或状态为未启用，则结束处理，其他情况则继续处理。  
		根据**渠道号**查询对应的渠道信息，  
		如果未查询到则抛出异常，否则继续处理。  
		根据请求参数封装消息发送请求表数据，状态设置为初始化。  
		根据消息派发方式的策略选择最优派发方式，如果未匹配到派发方式则抛出异常。  
		如果匹配成功，则将消息派发方式ID记录到请求报文并入库到**MSG_REQUEST（消息请求表）**，同时入库**请求用户表**；  
		如果请求未通过，返回错误信息，提示请求错误。
		- 2.**当请求入库成功后。**
		> 根据**业务类型查询业务类型配置表**，获取当前业务类型的优先级及是否设置绿色通道。
		- 3.**封装请求ID， 设置消息优先级，根据是否查询到绿色通道分发到指定的消息队列中。**
		> 当**查询到绿色通道**时，将封装后的消息发送到指定的**绿色通道队列**中；  
		> 当**未查询到**绿色通道时，将封装后的消息发送到**通用队列**中。  
		> 消息请求队列订阅消息请求队列，根据消息请求队列中的消息进行业务处理生成衍生消息。  
		> 消息请求队列有一个通用队列及多个绿色通道队列。
		- 4.**接收消息请求队列中的内容，解析为对应的请求ID。**
		- 5.**根据请求ID查询MSG_REQUEST（消息请求表）。**  
		> 如果消息表中不存在对应的请求ID记录，结束处理。 
		- 6.**如果消息表中存在，判断请求的处理状态。**  
		> 当请求状态为初始化|处理失败时，将状态设置为处理中，并执行步骤4；  
		> 当请求状态为处理中|处理成功时，结束处理。
		- 7.**根据请求中的消息派发方式ID对应的关联信息的发送方式，将请求拆解为多条消息发送记录。**  
		> 根据派发方式及设备类型不同，可生成不同的消息发送记录，如信鸽、短信及MQ等。  
		> 分别计算消息发送记录的必要字段信息。  
		>> （1）如果消息请求中设置了不使用消息模板，  
		      则将请求中的消息内容设置到生成的消息发送记录中的消息标题和消息内容中。  
		   （2）如果消息请求表中设置里使用模板，  
				则根据派发方式查询对应的派发方式关联信息，使用关联信息中的消息模板ID查询消息模板配置表中的消息模板内容，把消息模板内容中的标题和内容设置为消息发送记录的消息标题和消息内容。
		- 8.**根据消息请求查询消息请求用户表，**  
		> 如果消息派发配置关联信息中配置了派发客户类型，则筛选出对应的客户类型数据。  
		> 封装成消息发送记录用户消息并关联对应的消息发送记录。
		- 9.**将消息发送记录和消息发送用户信息入库。**  
		> 将消息发送记录插入到消息发送记录表中，发送状态设置为未发送。  
		> 将消息发送用户信息记录到消息发送用户信息表中。同时更新请求的状态为处理成功。
		- 10.**当发送方式为信鸽且用户列表不为空时，**  
		> 根据消息发送记录及消息发送用户信息生成用户消息信息表并入库。
		- 11.**根据绿色通道的设置分发到不同的消息队列中等待处理。**  
		> 如果消息发送记录在业务类型派发方式配置表中**存在**绿色通道，则将消息发送记录推送到对应的**绿色通道**中；  
		> 如果消息发送记录在业务类型派发方式配置表中 **不存在**绿色通道，则将消息发送记录推送到消息发送记录处理**通用队列**。  
		> 消息发送记录处理队列订阅消息发送记录队列，根据消息发送记录队列中的消息进行业务处理执行相应的发送操作。  
		> 消息发送记录处理队列分为一个通用队列和多个绿色通道队列。
		- 12.**接收消息发送记录处理队列中的消息，并判断消息发送记录对应的派发方式。**  
		> 判断消息派发配置关联信息中的发送时间和限制发送次数:  
		>> 如果当前时间不在发送时间段内，不执行发送。  
		>> 如果发送次数**大于等于**限制发送次数，不执行发送并修改为无法发送。 
 
		> 发送状态判断:  
		>> 未发送|发送失败->发送中，  
		>> 发送中、发送成功、无法发送->结束处理。
		- 13.**针对信鸽推送的数据，**  
		> 根据不同的设备类型封装信鸽推送消息并调用信鸽接口执行发送，  
		> 发送成功后更新消息发送记录的发送状态为成功，  
		> 发送失败则设置发送状态为失败。  
		> 同时更新发送次数，当消息发送记录的**发送状态为失败且发送次数大于一定次数**时不再执行发送操作。
		- 14.**针对短信发送的数据，**  
		> 封装短信发送格式消息并调用sms系统执行发送，  
		> 发送成功后更新消息发送记录的发送状态为成功，  
		> 发送失败则设置发送状态为失败。  
		> 同时更新发送次数，当消息发送记录的**发送状态为失败且发送次数大于一定次数**时不再执行发送操作。 
		- 15.**针对mq发送的数据，**  
		> 封装成对应的mq消息格式并发送到指定的mq队列中，  
		> 发送成功后更新消息发送记录的发送状态为成功，  
		> 发送失败则设置发送状态为失败。  
		> 同时更新发送次数，当消息发送记录的**发送状态为失败且发送次数大于一定次数**时不再执行发送操作。  
		> **调度任务主要是用于扫描未处理或处理的失败的记录，再次发起相应的处理操作。**  
		> 调度任务分为**消息请求调度**扫描任务和**消息发送记录处理调度**任务。
		- 16.**请求扫描调度。**  
		> 查询请求表中处理状态为初始化及失败的数据，以及较长时间处于处理中的数据，  
		> 判断是否符合消息派发方式中的发送时间范围内，  
		> 将处理状态修改为失败状态并查询业务类型配置表，获取对应的绿色通道。  
		> 如果绿色通道存在，则将扫描到的数据推送到绿色通道；  
		> 如果绿色通道不存在，则将扫描到的数据推送到消息请求处理的通用通道。  
		> 调度任务主要是用于扫描未处理或处理的失败的记录，再次发起相应的处理操作。  
		> *消息发送记录处理调度任务。*
		>> 查询消息记录表中发送状态为初始化、失败且发送次数小于限制发送次数、较长时间处于处理中的消息发送记录数据,将发送状态修改为失败状态。  
		>>并查询业务类型派发方式配置表，获取对应的绿色通道。  
		>> 如果绿色通道存在，则将扫描到的消息推送到消息发送记录处理的绿色通道；  
		>> 如果绿色通道不存在，则将扫描到的数据推送到消息发送处理通用队列。


2. 验证码发送流程  

	- 请求URL: /api/hcmsg/captcha/send
	- 请求方式:POST
	- 请求参数：  
	> <table>
		<tr><th>序号</th><th>字段中文名称</th><th>字段名称</th><th>是否主键</th><th>是否可空</th><th>备注</th></tr>
		<tr><td>1	<td>ID	<td>ID	<td>是	<td>否	<td>主键    </tr>
		<tr><td>2	<td>请求ID	<td>REQ_ID	<td>　	<td>否	<td>唯一索引  </tr>
		<tr><td>3	<td>接收手机号	<td>PHONE_NM	<td>　	<td>否 <td></tr>
		<tr><td>4	<td>客户编号	<td>CUST_NO	　<td>	<td>是	  　<td></tr>
		<tr><td>5	<td>业务场景编号	<td>BIZ_CODE	<td>　	<td>否	<td></tr>
		<tr><td>6	<td>验证码格式	<td>CAPTCHA_TYPE	<td>　	<td>是<td></tr>
		<tr><td>7	<td>进件渠道	<td>CHANNEL_NO	<td>　	<td>是	　<td></tr>
		<tr><td>8	<td>贷款品种编码	<td>PRODUCT_ID	<td>　	<td>是<td></tr>
		<tr><td>9	<td>客户标签	<td>USER_FLAG	<td>　	<td>是	<td></tr>
		<tr><td>10	<td>创建时间	<td>CREATE_TIME	<td>　	<td>否	<td></tr>					    
		<tr><td>11	<td>修改时间	<td>MODIFY_TIME	　<td>	<td>否	<td></tr>	
		</table>

	- 返回参数：
	> <table>
		<tr><th></th><th>名称</th><th>类型</th><th>必填</th><th>备注</th></tr>
		<tr><td>1	<td>head	<td>object	<td>true	<td>
		<tr><td>2	<td>head->retMsg	<td>string	<td>true	<td>返回描述，对应的描述信息
		<tr><td>2	<td>head->retFlag	<td>string	<td>true	<td>返回码，00000表示调用成功
		<tr><td>1	<td>body	<td>object	<td>true	<td>
		<tr><td>2	<td>body->caseSensitive	<td>string	<td>true	<td>是否区分大小写，Y：区分；N：不区分
		<tr><td>2	<td>body->availTime	<td>string	<td>true	<td>有效时长，单位：秒
		<tr><td>2	<td>body->captchaId	<td>string	<td>true	<td>该条验证码对应的唯一id
		<tr><td>2	<td>body->checkCode	<td>string	<td>true	<td>验证码
		<tr><td>2	<td>body->seqNo	<td>number	<td>true	<td>验证码序号
	</table>

 - 流程概述：  
		- 1 **请求方发送验证码请求，其中包含对应的业务场景、验证码接收方、验证码格式等信息；**  
		> 收到请求后进行参数校验：  
		> ①验证手机号、验证码格式等参数是否规范；  
		> ②验证业务场景是否支持：  
		>> 查询redis所有支持的业务场景，  
		>> 若无查询结果（key不存在），则查询数据库中业务场景配置表，并更新缓存；    
		>> 若存在，判断查询出的集合中元素是否包含请求中的业务场景，  
		>>>不包含，则返回不支持的业务场景；  
		>>>包含，则请求存入验证码发送请求表
		- 2 **验证码发送请求处理：**
		> (1) **生成验证码序号：**  
		>> 根据手机号、业务场景查询redis缓存中当前业务场景下手机号对应的发送序号，  
		>> 已存在则当前序号+1；  
		>> 无结果则根据手机号、业务场景编号、状态、创建时间四个维度查询数据库验证码发送记录表中最新的发送序号，  
		>>无结果序号=1，已存在当前序号+1，并更新缓存。  

		> （2) **根据业务场景查询缓存中该业务场景下限制发送次数、有效时长（单位秒）、短信中业务场景描述、模板ID、派发方式ID配置，是否区分大小写、是否推送MQ等信息。**  
		>> 若缓存中不存在，则根据业务场景编号查询业务场景配置表，  
		>> 查询结果为空返回不支持的业务场景，  
		>> 不为空根据其id查询业务场景模板关联表，检索出上述信息，之后更新缓存。  

		> (3) **判断生成序号是否超过发送次数限制，**  
		>> 超过，则返回发送失败；  
		>> 不超过，则
		>>> ①根据验证码生成策略（文末说明），生成验证码短信内容，发送记录状态为初始化，发送记录存入验证码发送记录表，  
		>>> ②更新Redis缓存，若出现异常则发送记录状态修改为发送失败，并返回验证码发送失败，程序结束；  
		>>> 若更新成功，则  
		>>>> ③根据验证码发送记录和派发方式，封装link请求参数，根据业务场景配置信息中是否推送MQ的值，决定是否进行MQ推送。若不推送，则直接调用link服务进行验证码短信发送；  

		> （4） **不推送MQ，直接调用link服务：**  
		>> 短信发送成功，则  
		>>> ①验证码发送记录状态修改为：发送成功，  
		>>> ②将手机号在当前场景下的发送序号、手机号的验证码、验证码的有效日期、是否区分大小写重新存入缓存，  
		>>> ③返回验证码发送成功；

		>> 短信发送失败，则  
		>>> ①验证码发送记录状态修改为：发送失败，  
		>>> ②删除缓存；  
		>>> ③返回验证码发送失败；  

		> （5） **推送MQ，**  
		>> 则将请求参数放入队列，由队列去消费时调用link服务进行验证码短信发送，  
		>>> 若推送MQ成功，则直接返回该验证码发送成功，  
		>>> 推送MQ失败，返回发送失败。  
  
		>> 其他修改验证码发送记录状态以及对缓存的操作与4步骤中不推送MQ时一致。  

		> （6） **验证码生成策略：**  
		>> ①首先根据请求中的验证码格式生成相应的验证码；  
		>> ②根据模板ID去缓存中查询模板内容，  
		>>> 查询无结果，则根据此ID查询数据库中消息模板配置表，检索出该模板内容，之后更新缓存；  
		>>> 查询已存在，则通过业务场景描述、序号、有效时长、验证码和根据模板ID匹配的模板内容生成短信内容；  



3. 验证码验证流程
	- 请求URL：/api/hcmsg/captcha/verify  
	- 请求方式：POST  
	- 请求参数：
	> <table>
		<tr><th>名称<th>必填<th>参数位置<th>类型<th>默认值<th>长度<th>备注</th></tr>
		<tr><td>captchaId<td>true<td>普通参数<td>string<td><td>32<td>验证码发送接口返回的captchaId（该条验证码对应的唯一id）</tr>
		<tr><td>captcha<td>true<td>普通参数<td>string<td><td>32<td>验证码</tr>
		<tr><td>seqNo<td>true<td>普通参数<td>string<td><td>32<td>发送序号</tr>
		<tr><td>phoneNm<td>true<td>普通参数<td>string<td><td>32<td>手机号码</tr>
		<tr><td>bizCode<td>true<td>普通参数<td>string<td><td>32<td>业务场景编号</tr>	
  		</table>
	- 返回参数：
  	> <table>
		<tr><th><th>名称<th>	类型<th>	必填<th>	备注</th></tr>
		<tr><td>1	<td>head	<td>object	<td>true	
		<tr><td>2	<td>head->retMsg	<td>string	<td>true	<td>返回描述
		<tr><td>2	<td>head->retFlag	<td>string	<td>true	<td>返回码
		<tr><td>1	<td>body	<td>object	<td>true	
		<tr><td>2	<td>body->status	<td>string	<td>true	<td>验证状态，PASS：通过；UNPASS：未通过
		<tr><td>2	<td>body-> captchaId	<td>string	<td>true	<td>该条验证码对应的唯一id
		<tr><td>2	<td>body->errorCode	<td>string	<td>true	<td>错误码
		<tr><td>2	<td>body->errorMsg	<td>string	<td>true	<td>错误描述，验证未通过原因 
	</table>

	- 流程概述：  
	**以手机号和业务场景编号为key值（HCM:CAPTCHA:{PHONENM}:{BizCode}），从redis中查询对应的reqId**  
		> 1.查询redis返回结果为空，返回验证码已失效。  
		> 2.若查询redis返回结果reqId,以手机号和reqId为key值（HCM:CAPTCHA:{PHONENM}:{reqId})查询redis中的验证码信息。若验证码信息为空，则根据reqId查询验证码发送记录表，无数据返回验证失败，有数据则使用该条验证码发送记录中的验证码信息，然后根据验证规则进行验证。  
		> 3.若redis查询异常则直接从验证码发送记录表根据reqId查询验证码发送记录，然后根据验证规则进行验证。  
	
		**验证码验证规则：**  
		> ①序号与请求中的发送序号一致，则验证验证码是否一致；发送序号与请求中的不一致，返回验证码序号不匹配，请输入正确序号的验证码;  
		> ②据是否区分大小写，判断验证码是否与请求中的一致，一致进行验证码校验；不一致，返回验证码错误，请重新输入。    
		> ③若当前时间小于验证码的有效日期，返回验证通过，修改该条验证码发送记录状态修改为验证通过；大于验证码有效日期，返回验证码已失效，请重新发送验证码，并修改该条验证码发送记录状态修改为已失效，redis删除HCM:CAPTCHA:{PHONENM}:{BizCode}key和HCM:CAPTCHA:{PHONENM}:{UUID}key；
